services:
  dynamodb:
    image: amazon/dynamodb-local:2.5.2
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    ports:
      - "8000:8000"

  localstack:
    image: localstack/localstack:3.7
    environment:
      - SERVICES=s3,sqs
      - DEBUG=0
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack

  api:
    build:
      context: ./api
    environment:
      - NODE_ENV=development
      - PORT=3000
      - LOG_LEVEL=info
      - XRAY_DISABLED=true

      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test

      - DDB_ENDPOINT_URL=http://dynamodb:8000
      - SQS_ENDPOINT_URL=http://localstack:4566
      - S3_ENDPOINT_URL=http://localstack:4566
      - S3_PUBLIC_ENDPOINT_URL=http://localhost:4566
      - S3_FORCE_PATH_STYLE=true

      - DDB_TABLE_QUIZZES=quizzes
      - DDB_TABLE_ATTEMPTS=attempts
      - DDB_TABLE_EXPORTS=exports
      - S3_BUCKET=code-quiz-exports
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/code-quiz-jobs
    depends_on:
      - dynamodb
      - localstack
    ports:
      - "3000:3000"

  worker:
    build:
      context: ./worker
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=info
      - XRAY_DISABLED=true

      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test

      - DDB_ENDPOINT_URL=http://dynamodb:8000
      - SQS_ENDPOINT_URL=http://localstack:4566
      - S3_ENDPOINT_URL=http://localstack:4566
      - S3_FORCE_PATH_STYLE=true

      - DDB_TABLE_QUIZZES=quizzes
      - DDB_TABLE_ATTEMPTS=attempts
      - DDB_TABLE_EXPORTS=exports
      - S3_BUCKET=code-quiz-exports
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/code-quiz-jobs
      - WORKER_POLL_INTERVAL_MS=2000
    depends_on:
      - dynamodb
      - localstack

  web:
    build:
      context: ./web
    environment:
      - NODE_ENV=production
    volumes:
      - ./web/nginx/nginx.local.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
    ports:
      - "8080:80"

  bootstrap-local:
    image: amazon/aws-cli:2.17.41
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-west-2
    depends_on:
      - localstack
      - dynamodb
    entrypoint: ["/bin/sh","-lc"]
    command: >
      '
      echo "Creating S3 bucket + SQS queue in LocalStack...";
      aws --endpoint-url=http://localstack:4566 s3api create-bucket --bucket code-quiz-exports --create-bucket-configuration LocationConstraint=us-west-2 || true;
      aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name code-quiz-jobs || true;

      echo "Creating DynamoDB tables in DynamoDB Local...";
      aws dynamodb create-table --endpoint-url=http://dynamodb:8000         --table-name quizzes         --attribute-definitions AttributeName=quizId,AttributeType=S         --key-schema AttributeName=quizId,KeyType=HASH         --billing-mode PAY_PER_REQUEST || true;

      aws dynamodb create-table --endpoint-url=http://dynamodb:8000         --table-name attempts         --attribute-definitions AttributeName=attemptId,AttributeType=S         --key-schema AttributeName=attemptId,KeyType=HASH         --billing-mode PAY_PER_REQUEST || true;

      aws dynamodb create-table --endpoint-url=http://dynamodb:8000         --table-name exports         --attribute-definitions AttributeName=exportId,AttributeType=S         --key-schema AttributeName=exportId,KeyType=HASH         --billing-mode PAY_PER_REQUEST || true;

      echo "Local bootstrap done.";
      '

volumes:
  localstack-data:
